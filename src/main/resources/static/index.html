<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å®æ—¶æ—¥å¿—å¯è§†åŒ–ç›‘æ§ç³»ç»Ÿ</title>
  <!-- å¼•å…¥ Chart.js ç”¨äºç»˜å›¾ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* é¡µé¢æ•´ä½“æ ·å¼ */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f4f6f8;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    /* æ¯å°è®¾å¤‡çš„æ•°æ®å¡ç‰‡æ ·å¼ */
    .device-container {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 30px;
    }

    .device-container h2 {
      margin-top: 0;
      color: #333;
    }

    .device-container p {
      margin: 6px 0;
    }

    .chart-box {
      width: 100%;
      height: 300px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
<h1>åˆ†å¸ƒå¼æ—¥å¿—å®æ—¶ç›‘æ§ç³»ç»Ÿ</h1>
<div id="device-data"></div>

<script>
  const deviceInfo = {}; // ä¿å­˜æ¯ä¸ªè®¾å¤‡å¯¹åº”çš„å›¾è¡¨å’Œæ•°æ®
  const maxPoints = 20;  // æŠ˜çº¿å›¾ä¸Šæ˜¾ç¤ºçš„æœ€å¤§æ•°æ®ç‚¹æ•°
  const socket = new WebSocket("ws://localhost:8080/ws"); // å»ºç«‹ WebSocket è¿æ¥

  // æ”¶åˆ°åç«¯æ¨é€æ¶ˆæ¯æ—¶è§¦å‘
  socket.onmessage = ({ data }) => {
    try {
      const json = JSON.parse(data); // è§£æ JSON æ•°æ®
      const deviceId = json.device_id;
      if (!deviceId) return; // å¦‚æœæ— è®¾å¤‡ IDï¼Œå¿½ç•¥

      // å¦‚æœæ˜¯é¦–æ¬¡æ¥æ”¶è¯¥è®¾å¤‡çš„æ•°æ®ï¼Œåˆå§‹åŒ– UI å¡ç‰‡
      if (!deviceInfo[deviceId]) {
        createDeviceCard(deviceId);
      }

      // æ›´æ–°è®¾å¤‡å¯¹åº”çš„å¡ç‰‡ä¿¡æ¯
      updateDeviceCard(deviceId, json);
    } catch (e) {
      console.error("JSON è§£æå¤±è´¥ï¼š", e);
    }
  };

  // åˆ›å»ºè®¾å¤‡å±•ç¤ºå¡ç‰‡å’Œå›¾è¡¨
  function createDeviceCard(deviceId) {
    const container = document.createElement("div");
    container.className = "device-container";
    container.id = `device_${deviceId}`;

    // å¡«å…… HTML å†…å®¹
    container.innerHTML = `
        <h2>è®¾å¤‡ ${deviceId}</h2>
        <p><strong>âš ï¸ WARN å æ¯”:</strong> <span class="warn-ratio">0%</span></p>
        <p><strong>âŒ ERROR å æ¯”:</strong> <span class="error-ratio">0%</span></p>
        <p><strong>ğŸ•’ æœ€è¿‘ä¸€æ¬¡ ERROR æ—¶é—´:</strong> <span class="last-error">æ— </span></p>
        <p><strong>ğŸš¨ ä¸¥é‡å‘Šè­¦æ¬¡æ•°:</strong> <span class="alert-count">0</span></p>
        <div class="chart-box">
          <canvas id="chart_${deviceId}"></canvas>
        </div>
      `;

    document.getElementById("device-data").appendChild(container);

    // åˆ›å»ºå›¾è¡¨
    const ctx = document.getElementById(`chart_${deviceId}`).getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [], // æ¨ªåæ ‡æ—¶é—´
        datasets: [
          {
            label: 'WARN æ•°é‡',
            data: [],
            borderColor: 'orange',
            backgroundColor: 'rgba(255,165,0,0.2)',
            tension: 0
          },
          {
            label: 'ERROR æ•°é‡',
            data: [],
            borderColor: 'red',
            backgroundColor: 'rgba(255,0,0,0.2)',
            tension: 0
          }
        ]
      },
      options: {
        responsive: true,
        animation: { duration: 300 },
        plugins: {
          legend: { position: 'top' }
        },
        scales: {
          x: { display: true },
          y: {
            beginAtZero: true,
            ticks: { precision: 0 } // çºµè½´ä¸ºæ•´æ•°åˆ»åº¦
          }
        }
      }
    });

    // ä¿å­˜è¯¥è®¾å¤‡å¯¹åº”çš„å›¾è¡¨å’Œè®¡æ•°å™¨
    deviceInfo[deviceId] = {
      alertCount: 0,
      chart,
      card: container
    };
  }

  // å°†æ—¶é—´å­—ç¬¦ä¸²æ ¼å¼åŒ–ä¸ºæ ‡å‡†æ—¶é—´
  function formatDateTime(input) {
    if (!input || input === "") return "";
    const date = new Date(input);
    if (isNaN(date.getTime())) return "";
    const pad = n => n.toString().padStart(2, '0');
    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ` +
            `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`;
  }

  // æ›´æ–°å·²æœ‰çš„è®¾å¤‡å¡ç‰‡å†…å®¹å’Œå›¾è¡¨æ•°æ®
  function updateDeviceCard(deviceId, data) {
    const { card, chart } = deviceInfo[deviceId];

    // å¦‚æœæ˜¯å‘Šè­¦ç±»æ¶ˆæ¯ï¼ˆå« alert_type å­—æ®µï¼‰
    if (data.alert_type) {
      deviceInfo[deviceId].alertCount++;
      card.querySelector(".alert-count").innerText = deviceInfo[deviceId].alertCount;
    } else {
      // æ™®é€šåˆ†æç±»æ•°æ®
      const {
        warn_count = 0,
        error_count = 0,
        warn_ratio = 0,
        error_ratio = 0,
        last_error_time = ""
      } = data;

      // æ›´æ–°é™æ€æ–‡æœ¬ä¿¡æ¯
      card.querySelector(".warn-ratio").innerText = `${(warn_ratio * 100).toFixed(1)}%`;
      card.querySelector(".error-ratio").innerText = `${(error_ratio * 100).toFixed(1)}%`;
      card.querySelector(".last-error").innerText = formatDateTime(last_error_time);

      // æ›´æ–°å›¾è¡¨æ•°æ®
      const time = new Date().toLocaleTimeString(); // å½“å‰æ—¶é—´ä½œä¸ºæ ‡ç­¾

      if (chart.data.labels.length >= maxPoints) {
        chart.data.labels.shift(); // ç§»é™¤æœ€æ—©çš„æ•°æ®
        chart.data.datasets[0].data.shift();
        chart.data.datasets[1].data.shift();
      }

      // æ·»åŠ æ–°æ•°æ®ç‚¹
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(warn_count);
      chart.data.datasets[1].data.push(error_count);
      chart.update(); // é‡æ–°æ¸²æŸ“å›¾è¡¨
    }
  }
</script>
</body>
</html>
